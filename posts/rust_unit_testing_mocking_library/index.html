<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Rust unit testing: mocking library - Jorge Ortiz-Fuentes&#39; DevBites</title><meta name="Description" content="Ferris scared of a black box."><meta property="og:url" content="https://jorgeortiz.dev/posts/rust_unit_testing_mocking_library/">
  <meta property="og:site_name" content="Jorge Ortiz-Fuentes&#39; DevBites">
  <meta property="og:title" content="Rust unit testing: mocking library">
  <meta property="og:description" content="Ferris scared of a black box.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-17T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-26T17:13:37+01:00">
    <meta property="article:tag" content="Rust">
    <meta property="article:tag" content="Test">
    <meta property="og:image" content="https://jorgeortiz.dev/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://jorgeortiz.dev/logo.png">
  <meta name="twitter:title" content="Rust unit testing: mocking library">
  <meta name="twitter:description" content="Ferris scared of a black box.">
<meta name="application-name" content="Jorge Ortiz-Fuentes&#39; DevBites">
<meta name="apple-mobile-web-app-title" content="Jorge Ortiz-Fuentes&#39; DevBites"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://jorgeortiz.dev/posts/rust_unit_testing_mocking_library/" /><link rel="prev" href="https://jorgeortiz.dev/posts/rust_unit_testing_assertion_libraries/" /><link rel="next" href="https://jorgeortiz.dev/posts/rust_unit_testing_file_reading/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Rust unit testing: mocking library",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/jorgeortiz.dev\/posts\/rust_unit_testing_mocking_library\/"
        },"genre": "posts","keywords": "rust, test","wordcount":  3281 ,
        "url": "https:\/\/jorgeortiz.dev\/posts\/rust_unit_testing_mocking_library\/","datePublished": "2025-11-17T00:00:00+00:00","dateModified": "2025-11-26T17:13:37+01:00","license": "\u0026copy; 2025 Jorge D. Ortiz Fuentes","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Jorge Ortiz-Fuentes"
            },"description": "Ferris scared of a black box."
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Jorge Ortiz-Fuentes&#39; DevBites">Jorge Ortiz-Fuentes&#39; DevBites</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Jorge Ortiz-Fuentes&#39; DevBites">Jorge Ortiz-Fuentes&#39; DevBites</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Rust unit testing: mocking library</h1><h2 class="single-subtitle">Using libraries for mocking</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://www.linkedin.com/in/jorgeortiz/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Jorge Ortiz-Fuentes</a></span>&nbsp;<span class="post-category">included in <a href="/categories/tutorial/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Tutorial</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-11-17">2025-11-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3281 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;16 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/rust_unit_testing_mocking_library/header-image.jpg"
        data-srcset="/posts/rust_unit_testing_mocking_library/header-image.jpg, /posts/rust_unit_testing_mocking_library/header-image.jpg 1.5x, /posts/rust_unit_testing_mocking_library/header-image.jpg 2x"
        data-sizes="auto"
        alt="/posts/rust_unit_testing_mocking_library/header-image.jpg"
        title="Ferris scared of a black box." width="832" height="448" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
<ul>
<li><a href="#headline-1">Create a Megaweapon mock with mockall</a>
</li>
<li><a href="#headline-2">Convert the stub</a>
</li>
<li><a href="#headline-3">Replace the dummy with mockall</a>
</li>
<li><a href="#headline-4">A spy with some non-trivial logic</a>
</li>
<li><a href="#headline-5">Implement custom behavior in the mock</a>
</li>
<li><a href="#headline-6">Final code</a>
</li>
<li><a href="#headline-7">Summary</a>
</li>
<li><a href="#headline-8">Footnotes</a>
</li>
</ul>
</nav></div>
            </div><div class="content" id="content">
<p>
In earlier articles about test doubles, I showed how to create them without using any libraries.  While I believe that
is the best way to understand how they work, how they can help, and how to use them, it is far from being a convenient
way of writing your tests.</p>
<p>
In this article, I will explain how to use a mocking library and replace all the test doubles we wrote with others that
are produced by the library.  Prepare for a more streamlined version of the code that achieves the same goals with less
effort!</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Create a Megaweapon mock with mockall
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>Working for a supervillain is indeed challenging.  You must be very productive if you don&#39;t want to mark yourself for
workforce <del>elimination</del>, ahem, reduction.  Hence, writing your test doubles from scratch doesn&#39;t seem to be a smart
move.  What then?  Well, let me introduce you to the mocking libraries.  Basically, they implement the same
functionality we did manually in a more reusable manner.  And don&#39;t be afraid: they can be used to create all your test
doubles, not just mocks.</p>
<p>
One of the most popular mocking libraries for Rust is <a href="https://crates.io/crates/mockall">mockall</a>.  It provides an ergonomic and robust API that leverages
procedural macros to produce, control, and verify test doubles. Let&#39;s use it to replace the manually written test
doubles and simplify the code.</p>
<p>
The first test double that we will replace is the <code>Megaweapon</code>.  But first, we need to add <code class="verbatim">mockall</code> to the project
using cargo.  Since <code class="verbatim">mockall</code> is a dependency that we only want to include for our tests, not our production code, we
specify it as a development dependency with the corresponding option.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  cargo add --dev mockall</span></span></code></pre></div>
</div>
<p>
Then, to replace the manual test double we created in <code class="verbatim">supervillain.rs</code> with one produced and controlled by <code class="verbatim">mockall</code>,
we need to import it.  But we only want <code class="verbatim">mockall</code> imported when the code is compiled for testing.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall</span>::<span class="n">automock</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
<code class="verbatim">mockall</code> produces test doubles automatically just using the <code>automock</code> attribute.  And again, we only want this to
happen when the code is compiled for testing, so we use a conditional attribute that we add to the <code class="verbatim">Megaweapon</code> trait.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg_attr(test, automock)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Megaweapon</span><span class="w"> </span><span class="p">{</span></span></span></code></pre></div>
</div>
<p>
There are two tests that use <code>WeaponDouble</code>: <code>non_intensive_attack_shoots_weapon_once()</code> and
<code>intensive_attack_shoots_weapon_twice_or_more()</code>.  Let&#39;s start with the first one.</p>
<p>
In the <code>non_intensive_attack_shoots_weapon_once()</code> test, we modify the creation of the test double.  Instead of using
<code>WeaponDouble</code>, our manually written test double, we use <code>MockMegaweapon</code> ‚Äì&#34;Mock&#34; + trait name‚Äì that is the type
produced by the <code>automock</code> attribute.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">weapon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockMegaweapon</span>::<span class="n">new</span><span class="p">();</span></span></span></code></pre></div>
</div>
<p>
Now that we have replaced our manual test double with the <code class="verbatim">mockall</code> one, we instruct it to expect its <code>shot()</code> method to
be invoked only once and to return nothing.  It is important that we do this at the beginning, in the arrangement part
of the test, before we use it.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="n">weapon</span><span class="p">.</span><span class="n">expect_shoot</span><span class="p">().</span><span class="n">once</span><span class="p">().</span><span class="n">return_const</span><span class="p">(());</span></span></span></code></pre></div>
</div>
<p>
As you can see, the <code>automock</code> attribute macro applied to a trait ‚Äì<code>Megaweapon</code> in this case‚Äì defines a new type with
the same name preceded by &#34;Mock&#34; and generates a method for each of the existing ones in the trait, but preceded by
&#34;expect_&#34;.  We can use those methods to declare your expectations.  We don&#39;t need to add any assertions at the end of
the test, because the verification of those expectations is done automatically at the end of the test scope.  <code class="verbatim">mockall</code>
uses the drop trait to perform the verification, as we did in our previous work.</p>
<p>
Running the tests with <code class="verbatim">cargo t --lib</code> will show us that we have successfully replaced the test double in the first
test.  Now we can do the same with the second one, as shown below.  We could have omitted the call count expectation
<code>times()</code>, and it should still work.  However, it would also pass if the supervillain shoots just once or 10 times
instead of the expected two or three.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">intensive_attack_shoots_weapon_twice_or_more</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">weapon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockMegaweapon</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">weapon</span><span class="p">.</span><span class="n">expect_shoot</span><span class="p">().</span><span class="n">times</span><span class="p">(</span><span class="mi">2</span><span class="o">..=</span><span class="mi">3</span><span class="p">).</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">attack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">weapon</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
There is no need to keep the <code class="verbatim">WeaponDouble</code> or its implementation blocks, so we can remove them.  We can also get rid of
the functions <code>once()</code> and <code>at_least()</code> that we created for these two tests.</p>
<p>
With all these changes in place, we run the tests again with <code class="verbatim">cargo t --lib</code> and celebrate our first mocktail party üç∏.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Convert the stub
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>Using <code class="verbatim">mockall</code> has already simplified our tests.  At least the ones that were using the <code>Megaweapon</code>.  Our next scenario would
be to convert the stubbing part of the sidekick to use <code class="verbatim">mockall</code>, too.  In this case, we are not working with a trait,
but with a concrete type.</p>
<p>
In <code class="verbatim">sidekick.rs</code>, we import <code class="verbatim">mockall</code> for tests, as we did in the previous section.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall</span>::<span class="n">automock</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
Then, we add a macro to the implementation block of <code class="verbatim">Sidekick</code>, so a mock is automatically produced when we compile
for testing.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg_attr(test, automock)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">impl</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Sidekick</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span></span></span></code></pre></div>
</div>
<p>
This should have taken us a step closer, but when we compile to check that everything goes fine, the compiler complains
about numerous errors related to lifetimes.  Thankfully, there is another way to create a mock with <code class="verbatim">mockall</code>.  It is
known as <em>manual mock</em><sup class="footnote-reference"><a id="footnote-reference-1" href="#footnote-1">1</a></sup> and uses the <code>mock!</code> attribute, and it provides us with more control over the mock that is
produced.  We start by replacing the import in <code class="verbatim">sidekick.rs</code> and removing the conditional <code>automock</code> attribute of the
implementation block.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall</span>::<span class="n">mock</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
Now, we can create the mock manually by declaring the methods that we need to mock also in <code class="verbatim">sidekick.rs</code>.  Notice that
<code>get_weak_targets()</code> has been modified slightly to simplify the mocking, and <code>new()</code> hasn&#39;t been mocked.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="fm">mock!</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="n">Sidekick</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">agree</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_weak_targets</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_gadget</span>: <span class="kp">&amp;</span><span class="na">&#39;a</span> <span class="nc">dyn</span><span class="w"> </span><span class="n">Gadget</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">tell</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_ciphered_msg</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
Providing a different version of a concrete type solely for testing requires using another crate that performs the
modifications to the import paths for the tests, using different namespaces for the original type and the test double.</p>
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">  cargo add --dev mockall_double</span></span></code></pre></div>
</div>
<p>
This crate provides us with the <code>double</code> macro that changes the namespace when importing.  We use it in
<code class="verbatim">supervillain.rs</code> and remove the imports of <code class="verbatim">Sidekick</code>, both for testing and regular use.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall_double</span>::<span class="n">double</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg_attr(test, double)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">sidekick</span>::<span class="n">Sidekick</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
Here, I would also like to transform the tests progressively, but <code class="verbatim">mockall_double</code> is an all-or-nothing change.  So, we
comment out all but the tests that use the <code class="verbatim">Sidekick</code> test double.  That means that we temporarily disable
<code>fire_sidekick_if_doesnt_agree_with_conspiracy()</code>, <code>world_domination_stage1_builds_hq_in_first_weak_target()</code>, and
<code>tell_plans_sends_ciphered_message()</code> and we work on <code>keep_sidekick_if_agrees_with_conspiracy()</code>.</p>
<p>
In the test that we haven&#39;t commented out, we modify the creation of the mock instance using the original type and the
constructor produced by the attribute.  We declare the expectations using the same format as before, but in this case,
we use <code>return_const()</code> to provide the desired response to that invocation.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">keep_sidekick_if_agrees_with_conspiracy</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sidekick</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">mock_sidekick</span><span class="p">.</span><span class="n">expect_agree</span><span class="p">().</span><span class="n">once</span><span class="p">().</span><span class="n">return_const</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">mock_sidekick</span><span class="p">);</span></span></span></code></pre></div>
</div>
<p>
We run the tests and get an error about <code>Sidekick</code> (double) not implementing <code>Debug</code>.  So we derive the <code>Debug</code> trait in
the mock declaration.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="fm">mock!</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="n">Sidekick</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">agree</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_weak_targets</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_gadget</span>: <span class="kp">&amp;</span><span class="na">&#39;a</span> <span class="nc">dyn</span><span class="w"> </span><span class="n">Gadget</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">tell</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_ciphered_msg</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
This time, when we run the tests again with <code class="verbatim">cargo t --lib</code>, this one should pass.  Let&#39;s uncomment the second one, make
similar changes to it, and verify that it passes.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">fire_sidekick_if_doesnt_agree_with_conspiracy</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sidekick</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">mock_sidekick</span><span class="p">.</span><span class="n">expect_agree</span><span class="p">().</span><span class="n">once</span><span class="p">().</span><span class="n">return_const</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">mock_sidekick</span><span class="p">);</span></span></span></code></pre></div>
</div>
<p>
Let&#39;s go with the third. In this case, we are using the mock as a stub, but we are also verifying that the method
<code>get_weak_targets()</code> is invoked.  We also use <code>returning()</code> instead of <code>return_const()</code> because the returned value
depends on the execution of a closure.  We leave the gadget and henchman test doubles as they are for now.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">world_domination_stage1_builds_hq_in_first_weak_target</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="n">gdummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GadgetDummy</span><span class="w"> </span><span class="p">{};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hm_spy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HenchmanDouble</span>::<span class="n">default</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sidekick</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">mock_sidekick</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">.</span><span class="n">expect_get_weak_targets</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">.</span><span class="n">returning</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">test_common</span>::<span class="no">TARGETS</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">).</span><span class="n">to_vec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">mock_sidekick</span><span class="p">);</span></span></span></code></pre></div>
</div>
<p>
The last test is a little bit different.  We want to verify that the method is invoked with the right argument.  We
import the predicate for checking the value of the argument (<code>use mockall::predicate::eq;</code>).</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">tell_plans_sends_ciphered_message</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sidekick</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mock_sidekick</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">expect_tell</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">test_common</span>::<span class="no">MAIN_CIPHERED_MESSAGE</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">mock_sidekick</span><span class="p">);</span></span></span></code></pre></div>
</div>
<p>
Now that we have fully replaced our <code class="verbatim">Sidekick</code> test double, we can delete it, i.e., the full <code>doubles</code> module.  That
<strong>is</strong> some relevant simplification of our code.  It seems that this effort to use <code class="verbatim">mockall</code> is paying off.  Yay!</p>
<p>
Run the tests with <code class="verbatim">cargo t --lib</code> and take pride in the results.</p>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
Replace the dummy with mockall
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>We had replaced ‚Äìand simplified a lot‚Äì the <code class="verbatim">Sidekick</code> test double.  Let&#39;s now substitute the <code>GadgetDummy</code> test
double.  Remember that the dummies don&#39;t require any particular functionality.  When a function or method takes an
instance of a type, but it is not used in the code are testing, we use a dummy.  This is going to be very easy using
what we have already learned about <code class="verbatim">mockall</code>.</p>
<p>
We first import the <code>automock</code> macro in <code class="verbatim">gadget.rs</code>.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall</span>::<span class="n">automock</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
We enable auto-mocking for the <code>Gadget</code>.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg_attr(test, automock)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Gadget</span>: <span class="nb">Send</span> <span class="p">{</span></span></span></code></pre></div>
</div>
<p>
We replace <code>GadgetDummy</code> in the only test where it is used.  We don&#39;t need to declare any expectations because it is a
dummy.  Having an instance that we can use is good enough for the tests.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">world_domination_stage1_builds_hq_in_first_weak_target</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="n">gdummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockGadget</span>::<span class="n">new</span><span class="p">();</span></span></span></code></pre></div>
</div>
<p>
But the compiler cannot find <code>MockGadget</code>.  It has been created in the <code>gadget</code> module, and we haven&#39;t imported it yet.
Let&#39;s import it into the test module.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">gadget</span>::<span class="n">MockGadget</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
We can delete the <code>GadgetDummy</code> and run the tests.  They all pass.</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
A spy with some non-trivial logic
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>The next target is to convert the <code>Henchman</code> test double.  This is used in two tests:
<code>world_domination_stage1_builds_hq_in_first_weak_target()</code> and
<code>world_domination_stage2_tells_henchman_to_do_hard_things_and_fight_with_enemies()</code>.</p>
<p>
Again, we import <code class="verbatim">automock</code> in <code class="verbatim">henchman.rs</code>.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall</span>::<span class="n">automock</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
The <code>Henchman</code> can be auto-mocked using the <code>automock</code> attribute.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg_attr(test, automock)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Henchman</span><span class="w"> </span><span class="p">{</span></span></span></code></pre></div>
</div>
<p>
As we have learned in the previous section, we need to import <code>MockHenchman</code> into the tests.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">henchman</span>::<span class="n">MockHenchman</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
In the first test using a henchman test double, we would like to verify that they are instructed to build the secret
headquarters at a specified location.  This is very similar to the previous cases, but we need to check that its method
is invoked with the right argument.  The function <code>with()</code> is used to check the value of the arguments used in the
method.  <code>with()</code> is used in conjunction with a predicate to implement various comparisons.  In this case, we just want
the argument to be exactly equal to the name of the first (location) target.  Let&#39;s use the mock and write the
expectation.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_henchman</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockHenchman</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">mock_henchman</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">expect_build_secret_hq</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">test_common</span>::<span class="no">FIRST_TARGET</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span></span></span></code></pre></div>
</div>
<p>
The mock is used to execute the method that we are testing, and we can delete the assertion because the mock will take
care of checking it when it goes out of scope.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">start_world_domination_stage1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">mock_henchman</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gdummy</span><span class="p">);</span></span></span></code></pre></div>
</div>
<p>
If we run the tests with <code class="verbatim">cargo t --lib</code>, they should all pass.</p>
<p>
So far so good, but henchmen were used in a test with more logic involved.  We want to verify that henchmen are
instructed to both fight enemies and do hard things.  Both methods must be invoked, but in a defined order.</p>
<p>
Let&#39;s first try to state the two expectations and solve this with what we have learned so far.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">world_domination_stage2_tells_henchman_to_do_hard_things_and_fight_with_enemies</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_henchman</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockHenchman</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">mock_henchman</span><span class="p">.</span><span class="n">expect_fight_enemies</span><span class="p">().</span><span class="n">once</span><span class="p">().</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">mock_henchman</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">.</span><span class="n">expect_do_hard_things</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">start_world_domination_stage2</span><span class="p">(</span><span class="n">mock_henchman</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
We run the test and see that it passes.  However, you will notice that I have stated the expectations in a different
order than the one that is used in the code.  Changing the order the other way around doesn&#39;t change the result.  In
many cases, that can be fine, but what happens if the order is relevant?  <code class="verbatim">mockall</code> provides <code>Sequence</code> to help us
specify the order in which things happen.  We create the <code>Sequence</code> and add each of the expectations to it in the
expected order.</p>
<p>
Let&#39;s change the test to make the order relevant.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sequence</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">mock_henchman</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">expect_fight_enemies</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">in_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">mock_henchman</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">expect_do_hard_things</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">in_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span></span></span></code></pre></div>
</div>
<p>
Run the tests with <code class="verbatim">cargo t --lib</code> and experiment with the order in which the <code>Henchman</code> performs actions in the method
being tested.  Our non-trivial logic can be successfully checked.</p>
<p>
Before we move on, we can also delete the <code class="verbatim">HenchmanDouble</code>.  One more left to go.</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
Implement custom behavior in the mock
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>Until now, our mock has replied with hard-coded answers.  But what if we want to return data that depends on the input
to our member functions?  <code class="verbatim">mockall</code> to the rescue again ü¶∏.</p>
<p>
As in the previous cases, we can start by importing <code>automock</code> in <code class="verbatim">cipher.rs</code>.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall</span>::<span class="n">automock</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
And we enable auto-mocking for the <code>Cipher</code>.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg_attr(test, automock)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Cipher</span><span class="w"> </span><span class="p">{</span></span></span></code></pre></div>
</div>
<p>
We go back to <code class="verbatim">supervillain.rs</code> and import <code>MockCipher</code> into the tests.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">henchman</span>::<span class="n">MockCipher</span><span class="p">;</span></span></span></code></pre></div>
</div>
<p>
In the test <code>tell_plans_sends_ciphered_message()</code>, we set the expectation for the cipher and use a closure to compute
the simplified logic for &#34;ciphering&#34;.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockCipher</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">mock_cipher</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">expect_transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">returning</span><span class="p">(</span><span class="o">|</span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&#34;+&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;+&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="n">tell_plans</span><span class="p">(</span><span class="n">test_common</span>::<span class="no">MAIN_SECRET_MESSAGE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mock_cipher</span><span class="p">);</span></span></span></code></pre></div>
</div>
<p>
The closure takes the same two arguments as the original <code>transform()</code> method and returns the same value ‚Äìa <code>String</code>‚Äì.
It uses the <code>secret</code> string to apply a simple change that proves the cipher has been used, returning a modified version
of it.</p>
<p>
Run the tests with <code class="verbatim">cargo t --list</code> and see them all pass.  You have used <code class="verbatim">mockall</code> to simplify your tests.  Congrats!</p>
<p>
As a last step, delete the <code class="verbatim">CipherDouble</code> test double.  We have eliminated more characters in this code, the
supervillains themselves.  Do you feel the power of the dark side?</p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
Final code
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>This time, we have introduced several changes to our code and removed many lines that are no longer needed.  The code in
the <code class="verbatim">supervillain.rs</code> file is provided below, but please note that we also made some changes to <code class="verbatim">sidekick.rs</code>.  You can
check the whole project, as always, in the corresponding commits of the <a href="https://github.com/jdortiz/detestable-me-rs">repo with all the code in this series</a>.</p>
<div class="src src-rust">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">  </span><span class="sd">//! Module for supervillains and their related stuff
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">  </span><span class="cp">#![allow(unused)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">Duration</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall</span>::<span class="n">automock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">mockall_double</span>::<span class="n">double</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">rand</span>::<span class="n">Rng</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">thiserror</span>::<span class="n">Error</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg_attr(test, double)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">sidekick</span>::<span class="n">Sidekick</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="p">{</span><span class="n">Cipher</span><span class="p">,</span><span class="w"> </span><span class="n">Gadget</span><span class="p">,</span><span class="w"> </span><span class="n">Henchman</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="sd">/// Type that represents supervillains.
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">  </span><span class="cp">#[derive(Default)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Supervillain</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="n">first_name</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="n">last_name</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="n">sidekick</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Sidekick</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="n">shared_key</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg_attr(test, automock)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Megaweapon</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">shoot</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">impl</span><span class="w"> </span><span class="n">Supervillain</span><span class="o">&lt;</span><span class="nb">&#39;_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="sd">/// Return the value of the full name as a single string.
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">///
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">/// Full name is produced concatenating first name, a single space, and the last name.
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">///
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">/// # Examples
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">/// ```
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">///# use evil::supervillain::Supervillain;
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">/// let lex = Supervillain {
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">///     first_name: &#34;Lex&#34;.to_string(),
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">///     last_name: &#34;Luthor&#34;.to_string(),
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">/// };
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">/// assert_eq!(lex.full_name(), &#34;Lex Luthor&#34;);
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="sd">/// ```
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">full_name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">format!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s"> </span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">last_name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_full_name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="n">components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#34; &#34;</span><span class="p">).</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Received </span><span class="si">{}</span><span class="s"> components.&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">components</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="n">components</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&#34;Name must have first and last name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="bp">self</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">to_string</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="bp">self</span><span class="p">.</span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">to_string</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">attack</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">weapon</span>: <span class="kp">&amp;</span><span class="nc">impl</span><span class="w"> </span><span class="n">Megaweapon</span><span class="p">,</span><span class="w"> </span><span class="n">intense</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">weapon</span><span class="p">.</span><span class="n">shoot</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="n">intense</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">rng</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="kd">let</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">random_range</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">weapon</span><span class="p">.</span><span class="n">shoot</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">come_up_with_plan</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">100</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&#34;Take over the world!&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">conspire</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">sidekick</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">sidekick</span><span class="p">.</span><span class="n">agree</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="bp">self</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">start_world_domination_stage1</span><span class="o">&lt;</span><span class="n">H</span>: <span class="nc">Henchman</span><span class="p">,</span><span class="w"> </span><span class="n">G</span>: <span class="nc">Gadget</span><span class="o">&gt;</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">henchman</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">H</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">gadget</span>: <span class="kp">&amp;</span><span class="nc">G</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">sidekick</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="kd">let</span><span class="w"> </span><span class="n">targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sidekick</span><span class="p">.</span><span class="n">get_weak_targets</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">targets</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">henchman</span><span class="p">.</span><span class="n">build_secret_hq</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">start_world_domination_stage2</span><span class="o">&lt;</span><span class="n">H</span>: <span class="nc">Henchman</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">henchman</span>: <span class="nc">H</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">henchman</span><span class="p">.</span><span class="n">fight_enemies</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">henchman</span><span class="p">.</span><span class="n">do_hard_things</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">tell_plans</span><span class="o">&lt;</span><span class="n">C</span>: <span class="nc">Cipher</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">cipher</span>: <span class="kp">&amp;</span><span class="nc">C</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">sidekick</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="kd">let</span><span class="w"> </span><span class="n">ciphered_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">shared_key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">sidekick</span><span class="p">.</span><span class="n">tell</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ciphered_msg</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">impl</span><span class="w"> </span><span class="n">TryFrom</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Supervillain</span><span class="o">&lt;</span><span class="nb">&#39;_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">type</span> <span class="nc">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EvilError</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">try_from</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="n">components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#34; &#34;</span><span class="p">).</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="n">components</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nb">Err</span><span class="p">(</span><span class="n">EvilError</span>::<span class="n">ParseError</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">purpose</span>: <span class="s">&#34;full_name&#34;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">reason</span>: <span class="s">&#34;Too few arguments&#34;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Supervillain</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">first_name</span>: <span class="nc">components</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">last_name</span>: <span class="nc">components</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="o">..</span><span class="nb">Default</span>::<span class="n">default</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[derive(Error, Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">EvilError</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[error(</span><span class="s">&#34;Parse error: purpose=&#39;{}&#39;, reason=&#39;{}&#39;&#34;</span><span class="cp">, .purpose, .reason)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ParseError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">purpose</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span>: <span class="nb">String</span> <span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">use</span><span class="w"> </span><span class="n">assertables</span>::<span class="p">{</span><span class="n">assert_matches</span><span class="p">,</span><span class="w"> </span><span class="n">assert_none</span><span class="p">,</span><span class="w"> </span><span class="n">assert_some</span><span class="p">,</span><span class="w"> </span><span class="n">assert_some_eq_x</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">use</span><span class="w"> </span><span class="n">mockall</span>::<span class="p">{</span><span class="n">Sequence</span><span class="p">,</span><span class="w"> </span><span class="n">predicate</span>::<span class="n">eq</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">use</span><span class="w"> </span><span class="n">test_context</span>::<span class="p">{</span><span class="n">AsyncTestContext</span><span class="p">,</span><span class="w"> </span><span class="n">TestContext</span><span class="p">,</span><span class="w"> </span><span class="n">test_context</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="p">{</span><span class="n">cipher</span>::<span class="n">MockCipher</span><span class="p">,</span><span class="w"> </span><span class="n">gadget</span>::<span class="n">MockGadget</span><span class="p">,</span><span class="w"> </span><span class="n">henchman</span>::<span class="n">MockHenchman</span><span class="p">,</span><span class="w"> </span><span class="n">test_common</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">full_name_is_first_name_space_last_name</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="n">full_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">full_name</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">full_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">test_common</span>::<span class="no">PRIMARY_FULL_NAME</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s">&#34;Unexpected full name&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">set_full_name_sets_first_and_last_names</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">set_full_name</span><span class="p">(</span><span class="n">test_common</span>::<span class="no">SECONDARY_FULL_NAME</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// assert2::check!(ctx.sut.first_name == &#34;A&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">          </span><span class="c1">// assert2::assert!(ctx.sut.last_name == &#34;B&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">          </span><span class="n">assert2</span>::<span class="fm">check!</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">first_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">test_common</span>::<span class="no">SECONDARY_FIRST_NAME</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">assert2</span>::<span class="fm">assert!</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">last_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">test_common</span>::<span class="no">SECONDARY_LAST_NAME</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[should_panic(expected = </span><span class="s">&#34;Name must have first and last name&#34;</span><span class="cp">)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">set_full_name_panics_with_empty_name</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">set_full_name</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">try_from_str_slice_produces_supervillain_full_with_first_and_last_name</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">EvilError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="n">sut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Supervillain</span>::<span class="n">try_from</span><span class="p">(</span><span class="n">test_common</span>::<span class="no">SECONDARY_FULL_NAME</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">sut</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">test_common</span>::<span class="no">SECONDARY_FIRST_NAME</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">sut</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="n">test_common</span>::<span class="no">SECONDARY_LAST_NAME</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">try_from_str_slice_produces_error_with_less_than_two_substrings</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Supervillain</span>::<span class="n">try_from</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&#34;Unexpected value returned by try_from&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">assert_matches!</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">EvilError</span>::<span class="n">ParseError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">purpose</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">purpose</span><span class="w"> </span><span class="o">==</span><span class="s">&#34;full_name&#34;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#34;Too few arguments&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">non_intensive_attack_shoots_weapon_once</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">weapon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockMegaweapon</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">weapon</span><span class="p">.</span><span class="n">expect_shoot</span><span class="p">().</span><span class="n">once</span><span class="p">().</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">attack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">weapon</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">intensive_attack_shoots_weapon_twice_or_more</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">weapon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockMegaweapon</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">weapon</span><span class="p">.</span><span class="n">expect_shoot</span><span class="p">().</span><span class="n">times</span><span class="p">(</span><span class="mi">2</span><span class="o">..=</span><span class="mi">3</span><span class="p">).</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">attack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">weapon</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[tokio::test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">plan_is_sadly_expected</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;</span><span class="nb">&#39;_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">come_up_with_plan</span><span class="p">().</span><span class="k">await</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Take over the world!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">keep_sidekick_if_agrees_with_conspiracy</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sidekick</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mock_sidekick</span><span class="p">.</span><span class="n">expect_agree</span><span class="p">().</span><span class="n">once</span><span class="p">().</span><span class="n">return_const</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">mock_sidekick</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">conspire</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">assert_some!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Sidekick fired unexpectedly&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">fire_sidekick_if_doesnt_agree_with_conspiracy</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sidekick</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mock_sidekick</span><span class="p">.</span><span class="n">expect_agree</span><span class="p">().</span><span class="n">once</span><span class="p">().</span><span class="n">return_const</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">mock_sidekick</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">conspire</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">assert_none!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Sidekick not fired unexpectedly&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">conspiracy_without_sidekick_doesnt_fail</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">conspire</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="fm">assert_none!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Unexpected sidekick&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">world_domination_stage1_builds_hq_in_first_weak_target</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="n">gdummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockGadget</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_henchman</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockHenchman</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mock_henchman</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">expect_build_secret_hq</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">test_common</span>::<span class="no">FIRST_TARGET</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sidekick</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mock_sidekick</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">expect_get_weak_targets</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">returning</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">test_common</span>::<span class="no">TARGETS</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">).</span><span class="n">to_vec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">mock_sidekick</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">start_world_domination_stage1</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">mock_henchman</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gdummy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">world_domination_stage2_tells_henchman_to_do_hard_things_and_fight_with_enemies</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_henchman</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockHenchman</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sequence</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mock_henchman</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">expect_fight_enemies</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">in_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mock_henchman</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">expect_do_hard_things</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">in_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">sequence</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">start_world_domination_stage2</span><span class="p">(</span><span class="n">mock_henchman</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test_context(Context)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">fn</span> <span class="nf">tell_plans_sends_ciphered_message</span><span class="p">(</span><span class="n">ctx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sidekick</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mock_sidekick</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">expect_tell</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">test_common</span>::<span class="no">MAIN_CIPHERED_MESSAGE</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">once</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">return_const</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="p">.</span><span class="n">sidekick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">mock_sidekick</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mock_cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MockCipher</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">mock_cipher</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">expect_transform</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">returning</span><span class="p">(</span><span class="o">|</span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&#34;+&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;+&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ctx</span><span class="p">.</span><span class="n">sut</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">.</span><span class="n">tell_plans</span><span class="p">(</span><span class="n">test_common</span>::<span class="no">MAIN_SECRET_MESSAGE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mock_cipher</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">struct</span> <span class="nc">Context</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">sut</span>: <span class="nc">Supervillain</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">impl</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AsyncTestContext</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Context</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">Context</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">sut</span>: <span class="nc">Supervillain</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">first_name</span>: <span class="nc">test_common</span>::<span class="no">PRIMARY_FIRST_NAME</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">last_name</span>: <span class="nc">test_common</span>::<span class="no">PRIMARY_LAST_NAME</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="o">..</span><span class="nb">Default</span>::<span class="n">default</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-7" class="outline-2">
<h2 id="headline-7">
Summary
</h2>
<div id="outline-text-headline-7" class="outline-text-2">
<p>In this article, I explain how to use a mocking library to create, control, and validate our test doubles.  The
underlying knowledge of how they work stays the same, but we have used <code class="verbatim">mockall</code> to simplify writing them.  The final
code will produce the same results with less effort and, hopefully, greater clarity.</p>
<p>
One non-trivial observation is that the functionality provided by <code class="verbatim">mockall</code> to express expectations over test doubles
coexists with other assertions, either the basic ones provided by the standard library or the fancy ones provided by the
assertion crates.  <code class="verbatim">mockall</code> expectations are used to express requirements on the test doubles, while assertions are
used for checking things about the type we are writing the tests for.  You can also think about it from a different
perspective: <code class="verbatim">mockall</code> expectations are used for behavior tests, and assertions are used for state and return tests.</p>
<p>
Stay curious. Hack your code. See you next time!</p>
</div>
</div>
<div id="outline-container-headline-8" class="outline-2">
<h2 id="headline-8">
Footnotes
</h2>
</div>
<div class="footnotes">
<hr class="footnotes-separatator"/>
<div class="footnote-definitions">
<div class="footnote-definition">
<sup id="footnote-1"><a href="#footnote-reference-1">1</a></sup>
<div class="footnote-body">
<p>Don&#39;t worry, we aren&#39;t going backwards.  This still quite automatic, but not as &#34;automagic&#34; as the <code>automock</code> attribute.</p>
</div>
</div>
</div>
</div>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-11-26&nbsp;<a class="git-hash" href="https://github.com/jdortiz/jdortiz.github.io/commit/3631d29d4fc30fb09494df99fcab3d2a33148ed1" target="_blank" title="commit by Jorge D. Ortiz-Fuentes(jorge.ortiz.fuentes@oracle.com) 3631d29d4fc30fb09494df99fcab3d2a33148ed1: Add article about using a mocking library in Rust">
                                    <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>3631d29</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://jorgeortiz.dev/posts/rust_unit_testing_mocking_library/" data-title="Rust unit testing: mocking library" data-hashtags="rust,test"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://jorgeortiz.dev/posts/rust_unit_testing_mocking_library/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="https://jorgeortiz.dev/posts/rust_unit_testing_mocking_library/" data-title="Rust unit testing: mocking library" data-web><i class="fab fa-whatsapp fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://jorgeortiz.dev/posts/rust_unit_testing_mocking_library/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/rust/">Rust</a>,&nbsp;<a href="/tags/test/">Test</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/rust_unit_testing_assertion_libraries/" class="prev" rel="prev" title="Rust unit testing: assertion libraries"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Rust unit testing: assertion libraries</a>
            <a href="/posts/rust_unit_testing_file_reading/" class="next" rel="next" title="Rust unit testing: file reading">Rust unit testing: file reading<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.152.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2025 - 2026</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://www.linkedin.com/in/jorgeortiz/" target="_blank">Jorge Ortiz-Fuentes</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-ELCV7TTK5E', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-ELCV7TTK5E" async></script></body>
</html>
